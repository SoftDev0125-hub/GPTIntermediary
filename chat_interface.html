<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatGPT Assistant - AI-Powered Automation</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <script>
        for(let i = 0; i < 30; i++) {
            let particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = Math.random() * 100 + '%';
            particle.style.animationDelay = Math.random() * 15 + 's';
            particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
            document.body.appendChild(particle);
        }
    </script>

    <div class="container">
        <div class="tab-bar">
            <button class="tab-button active" data-tab="chat">Chat</button>
            <button class="tab-button" data-tab="email">Email</button>
        </div>

        <div id="chat" class="tab-content active">
            <div class="header">
                <div class="header-content">
                    <h1>ChatGPT Assistant</h1>
                    <div class="status-badge">Online</div>
                </div>
            </div>

            <div class="chat-container" id="chatContainer">
                <div class="message system">
                    <div class="message-content">
                        <strong>Welcome to ChatGPT Assistant!</strong><br>
                        Your AI-powered automation system is ready. Try:<br>
                        &bull; "Launch calculator" or "Open notepad"<br>
                        &bull; "Send email to user@example.com"<br>
                        &bull; Or ask any question!
                    </div>
                </div>
            </div>

            <div class="typing-indicator" id="typingIndicator">
                <span></span>
                <span></span>
                <span></span>
            </div>

            <div class="input-container">
                <div class="input-wrapper">
                    <input 
                        type="text" 
                        id="messageInput" 
                        placeholder="Type your message or command..."
                        autocomplete="off"
                    />
                    <button id="sendButton" class="btn">Send</button>
                </div>
            </div>
        </div>

        <div id="email" class="tab-content">
            <div class="header">
                <div class="header-content">
                    <h1>Email Management</h1>
                    <div class="status-badge">Ready</div>
                </div>
            </div>

            <div class="email-container">
                <div class="email-header">
                    <h2>Inbox</h2>
                    <div class="email-count" id="emailCount">Unread: --</div>
                    <div class="button-group">
                        <button id="unreadButton" class="btn">Unread Mail</button>
                        <button id="refreshButton" class="btn btn-secondary">Refresh</button>
                    </div>
                </div>

                <div class="email-scroll-area">
                    <div id="emailList" class="email-list">
                        <div class="empty-state">
                            <div class="empty-state-text">Mail</div>
                            <p>Click "Unread Mail" to load your emails</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tabName = button.dataset.tab;
                
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                button.classList.add('active');
                document.getElementById(tabName).classList.add('active');
                
                if (tabName === 'chat') {
                    document.getElementById('messageInput').focus();
                }
            });
        });

        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const typingIndicator = document.getElementById('typingIndicator');

        function addMessage(text, type = 'assistant') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = text;
            
            messageDiv.appendChild(contentDiv);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            addMessage(message, 'user');
            messageInput.value = '';
            sendButton.disabled = true;

            typingIndicator.classList.add('active');

            try {
                const response = await fetch('http://localhost:5000/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                });

                const data = await response.json();
                typingIndicator.classList.remove('active');

                if (response.ok) {
                    addMessage(data.response, 'assistant');
                } else {
                    addMessage(`ERROR: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                typingIndicator.classList.remove('active');
                addMessage(`CONNECTION ERROR: ${error.message}`, 'error');
            }

            sendButton.disabled = false;
            messageInput.focus();
        }

        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        const unreadButton = document.getElementById('unreadButton');
        const refreshButton = document.getElementById('refreshButton');
        const emailList = document.getElementById('emailList');
        const emailCount = document.getElementById('emailCount');

        let allEmails = [];
        let currentPage = 1;
        let totalUnread = 0;
        const emailsPerPage = 10;

        function getTotalPages() {
            return Math.ceil(allEmails.length / emailsPerPage);
        }

        function updateEmailCount() {
            if (!emailCount) return;
            const shown = allEmails.length;
            const total = totalUnread || 0;
            emailCount.textContent = `Showing ${shown} / ${total} unread`;
        }

        // Get credentials from environment (exposed by backend)
        async function getUserCredentials() {
            try {
                const response = await fetch('http://localhost:5000/get_user_credentials');
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching credentials:', error);
                return null;
            }
        }

        function renderEmails() {
            const emailItems = allEmails.map(email => `
                <div class="email-item">
                    <div class="email-from">From: ${email.from_email || 'Unknown'}</div>
                    <div class="email-subject">${email.subject || '(No Subject)'}</div>
                    <div class="email-date">${email.date || new Date().toLocaleDateString()}</div>
                </div>
            `).join('');

            emailList.innerHTML = emailItems;
            updateEmailCount();
        }

        function goToPage(page) {
            const totalPages = getTotalPages();
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderEmails();
        }

        async function loadUnreadEmails() {
            unreadButton.disabled = true;
            unreadButton.textContent = 'Loading...';
            allEmails = [];
            currentPage = 1;
            totalUnread = 0;

            try {
                // Get real credentials
                console.log('[*] Fetching credentials...');
                const creds = await getUserCredentials();
                console.log('[*] Got credentials:', {
                    access_token: creds?.access_token ? creds.access_token.substring(0, 20) + '...' : 'NONE',
                    refresh_token: creds?.refresh_token ? creds.refresh_token.substring(0, 20) + '...' : 'NONE',
                    email: creds?.email
                });
                
                if (!creds || !creds.access_token) {
                    console.error('[!] Credentials missing');
                    emailList.innerHTML = '<div class="empty-state"><div class="empty-state-text">Error</div><p>Gmail credentials not found. Please restart the app.</p></div>';
                    if (emailCount) emailCount.textContent = 'Showing 0 / -- unread';
                    unreadButton.disabled = false;
                    unreadButton.textContent = 'Unread Mail';
                    return;
                }

                console.log('[*] Requesting unread emails from backend...');
                const response = await fetch('http://localhost:8000/api/email/unread', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_credentials: creds,
                        max_results: 1000
                    })
                });

                console.log('[*] Response status:', response.status);
                const data = await response.json();
                console.log('[*] Response data:', data);

                if (response.ok && data.success) {
                    allEmails = data.emails || [];
                    totalUnread = typeof data.total_unread === 'number' ? data.total_unread : allEmails.length;
                    updateEmailCount();
                    console.log(`[OK] Got ${allEmails.length} emails`);
                    if (allEmails.length === 0) {
                        emailList.innerHTML = '<div class="empty-state"><div class="empty-state-text">OK</div><p>No unread emails</p></div>';
                    } else {
                        currentPage = 1;
                        renderEmails();
                    }
                } else {
                    const errorMsg = data.error || data.detail || JSON.stringify(data);
                    console.error('[!] Backend error:', errorMsg);
                    emailList.innerHTML = `<div class="empty-state"><div class="empty-state-text">Error</div><p>${errorMsg}</p></div>`;
                    if (emailCount) emailCount.textContent = 'Showing 0 / -- unread';
                }
            } catch (error) {
                console.error('[!] Exception:', error);
                emailList.innerHTML = `<div class="empty-state"><div class="empty-state-text">Error</div><p>Exception: ${error.message}</p></div>`;
                if (emailCount) emailCount.textContent = 'Showing 0 / -- unread';
            }

            unreadButton.disabled = false;
            unreadButton.textContent = 'Unread Mail';
        }

        unreadButton.addEventListener('click', loadUnreadEmails);
        refreshButton.addEventListener('click', loadUnreadEmails);

        messageInput.focus();
    </script>
</body>
</html>
